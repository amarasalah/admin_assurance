<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MaghrebiaAdmin | Dashboard</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->

    <!-- SweetAlert2 -->

    <!-- Theme style -->





    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <!-- Ionicons -->
    <link
      rel="stylesheet"
      href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"
    />
    <!-- Tempusdominus Bootstrap 4 -->
    <link
      rel="stylesheet"
      href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css"
    />
    <!-- iCheck -->
    <link
      rel="stylesheet"
      href="plugins/icheck-bootstrap/icheck-bootstrap.min.css"
    />
    <!-- JQVMap -->
    <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css" />
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
    <!-- overlayScrollbars -->
    <link
      rel="stylesheet"
      href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css"
    />
    <!-- Daterange picker -->
    <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css" />
    <!-- summernote -->
    <link rel="stylesheet" href="plugins/summernote/summernote-bs4.min.css" />
    <link rel="stylesheet" href="plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
    <!-- Toastr -->
    <link rel="stylesheet" href="plugins/toastr/toastr.min.css">
  </head>
  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
      <!-- Preloader -->
      <div
        class="preloader flex-column justify-content-center align-items-center"
      >
        <img
          class="animation__shake"
          src="dist/img/AdminLTELogo.png"
          alt="AdminLTELogo"
          height="60"
          width="60"
        />
      </div>

      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
        </ul>
        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
          <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
              <i class="far fa-bell"></i>
              <span class="badge badge-warning navbar-badge">15</span>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
              <span class="dropdown-item dropdown-header"
                >15 Notifications</span
              >
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item">
                <i class="fas fa-envelope mr-2"></i> 4 new messages
                <span class="float-right text-muted text-sm">3 mins</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item">
                <i class="fas fa-users mr-2"></i> 8 friend requests
                <span class="float-right text-muted text-sm">12 hours</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item">
                <i class="fas fa-file mr-2"></i> 3 new reports
                <span class="float-right text-muted text-sm">2 days</span>
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item dropdown-footer"
                >See All Notifications</a
              >
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-light-primary elevation-4">
        <!-- Brand Logo -->
        <a href="index3.html" class="brand-link">
          <img
            src="dist/img/AdminLTELogo.png"
            alt="AdminLTE Logo"
            class="brand-image img-circle elevation-3"
            style="opacity: 0.8"
          />
          <span class="brand-text font-weight-bold">Admin Maghrebia</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Sidebar user panel (optional) -->
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <img
                src="dist/img/portrait-cute-girl-with-brown-hair-3d-rendering_1142-43502.jpg"
                class="img-circle elevation-2"
                alt="User Image"
              />
            </div>
            <div class="info">
              <a href="#" class="d-block">Zeineb Touil</a>
            </div>
          </div>

          <!-- SidebarSearch Form -->
          <div class="form-inline">
            <div class="input-group" data-widget="sidebar-search">
              <input
                class="form-control form-control-sidebar"
                type="search"
                placeholder="Search"
                aria-label="Search"
              />
              <div class="input-group-append">
                <button class="btn btn-sidebar">
                  <i class="fas fa-search fa-fw"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <li class="nav-item menu-open">
                <a href="./dashboard.html" class="nav-link active">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>Dashboard</p>
                </a>
              </li>
              <li class="nav-item menu-open">
                <a href="./contrat.html" class="nav-link ">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>Contrats</p>
                </a>
              </li>

            </ul>
          </nav>
          <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
      </aside>

      <!-- Content Wrapper. Contains page content -->
      <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Dashboard</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item active">Dashboard v1</li>
                </ol>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <section class="content mt-3">
          <div class="container-fluid">
            <div class="row align-items-center justify-content-center">
              <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3 id="response-count">0</h3>
                        <p>Nombre de contrats</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-bag"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        More info <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3 id="user-count">0</h3>
                        <p>Nombre d'Utilisateurs</p>
                    </div>
                    <div class="icon">
                        <i class="ion ion-stats-bars"></i>
                    </div>
                    <a href="#" class="small-box-footer">
                        More info <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

              </div>


            </div>

            <!-- Main row -->
            <div class="row">
              <div class="col-md-12">
                <!-- USERS LIST -->
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">Utilisateurs</h3>

                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body p-0">
                    <table class="table table-striped projects">
                      <thead>
                        <tr>
                          <th style="width: 1%">#</th>
                          <th style="width: 20%">Nom et Prénom Utilisateur</th>
                          <th style="width: 8%" class="text-center">
                            Nombres de contrats
                          </th>
                          <th style="width: 20%"></th>
                        </tr>
                      </thead>
                      <tbody id="user-table-body">
                        <!-- User data will be populated here by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                  <!-- /.card-body -->
                </div>
                <section class="content">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="card card-secondary">
                        <div class="card-header">
                          <h3 class="card-title">Ajouter un utilisateur</h3>
                          <div class="card-tools">
                            <button
                              type="button"
                              class="btn btn-tool"
                              data-card-widget="collapse"
                              title="Collapse"
                            >
                              <i class="fas fa-minus"></i>
                            </button>
                          </div>
                        </div>
                        <div class="card-body">
                          <form id="userForm">
                            <div class="form-group">
                              <label for="fullname">Nom et Prénom</label>
                              <input
                                type="text"
                                id="fullname"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="email">Email</label>
                              <input
                                type="email"
                                id="email"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="password">Password</label>
                              <input
                                type="password"
                                id="password"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="birthdate">Birthdate</label>
                              <input
                                type="date"
                                id="birthdate"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="country">Country</label>
                              <input
                                type="text"
                                id="country"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="nationalId">National ID</label>
                              <input
                                type="text"
                                id="nationalId"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="phone">Phone</label>
                              <input
                                type="tel"
                                id="phone"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="profileImageUrl">Profile Image URL</label>
                              <input
                                type="url"
                                id="profileImageUrl"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="username">Username</label>
                              <input
                                type="text"
                                id="username"
                                class="form-control"
                                required
                              />
                            </div>
                            <div class="form-group">
                              <label for="role">Role</label>
                              <select
                                id="role"
                                class="form-control custom-select"
                                required
                              >
                                <option selected disabled>Role</option>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                              </select>
                            </div>
                            <div class="row">
                              <div class="col-12">
                                <button
                                  type="button"
                                  id="submitBtn"
                                  class="btn btn-success float-right"
                                >
                                  Create New User
                                </button>
                              </div>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
                <!--/.card -->
              </div>
            </div>
          </div>
        </section>


        </div>
      </div>

      <!-- /.content-wrapper -->

      <footer class="main-footer">


      </footer>

      <!-- Control Sidebar -->
      <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
      </aside>
      <!-- /.control-sidebar -->
    </div>
    <!-- ./wrapper -->
    <div class="modal fade" id="modal-default">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">

            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-12">
                <div class="card card-secondary">
                  <div class="card-header">
                    <h3 class="card-title">Ajouter un utilisateur</h3>
                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                        title="Collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <form id="userForm">
                      <div class="form-group">
                        <label for="fullname">Nom et Prénom</label>
                        <input
                          type="text"
                          id="fullname"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="email">Email</label>
                        <input
                          type="email"
                          id="email"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="password">Password</label>
                        <input
                          type="password"
                          id="password"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="birthdate">Birthdate</label>
                        <input
                          type="date"
                          id="birthdate"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="country">Country</label>
                        <input
                          type="text"
                          id="country"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="nationalId">National ID</label>
                        <input
                          type="text"
                          id="nationalId"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="phone">Phone</label>
                        <input
                          type="tel"
                          id="phone"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="profileImageUrl">Profile Image URL</label>
                        <input
                          type="url"
                          id="profileImageUrl"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="username">Username</label>
                        <input
                          type="text"
                          id="username"
                          class="form-control"
                          required
                        />
                      </div>
                      <div class="form-group">
                        <label for="role">Role</label>
                        <select
                          id="role"
                          class="form-control custom-select"
                          required
                        >
                          <option selected disabled>Role</option>
                          <option value="user">User</option>
                          <option value="admin">Admin</option>
                        </select>
                      </div>
                      <div class="row">
                        <div class="col-12">
                          <button
                            type="button"
                            id="submitBtn"
                            class="btn btn-success float-right"
                          >
                            Create New User
                          </button>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>

    <!-- jQuery -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- SweetAlert2 -->
<script src="plugins/sweetalert2/sweetalert2.min.js"></script>
<!-- Toastr -->
<script src="plugins/toastr/toastr.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="dist/js/demo.js"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.js"></script>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-functions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-admin.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script>
      $(function() {
        var Toast = Swal.mixin({
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 3000
        });

        $('.swalDefaultSuccess').click(function() {
          Toast.fire({
            icon: 'success',
            title: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.swalDefaultInfo').click(function() {
          Toast.fire({
            icon: 'info',
            title: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.swalDefaultError').click(function() {
          Toast.fire({
            icon: 'error',
            title: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.swalDefaultWarning').click(function() {
          Toast.fire({
            icon: 'warning',
            title: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.swalDefaultQuestion').click(function() {
          Toast.fire({
            icon: 'question',
            title: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });

        $('.toastrDefaultSuccess').click(function() {
          toastr.success('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
        });
        $('.toastrDefaultInfo').click(function() {
          toastr.info('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
        });
        $('.toastrDefaultError').click(function() {
          toastr.error('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
        });
        $('.toastrDefaultWarning').click(function() {
          toastr.warning('Lorem ipsum dolor sit amet, consetetur sadipscing elitr.')
        });

        $('.toastsDefaultDefault').click(function() {
          $(document).Toasts('create', {
            title: 'Toast Title',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultTopLeft').click(function() {
          $(document).Toasts('create', {
            title: 'Toast Title',
            position: 'topLeft',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultBottomRight').click(function() {
          $(document).Toasts('create', {
            title: 'Toast Title',
            position: 'bottomRight',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultBottomLeft').click(function() {
          $(document).Toasts('create', {
            title: 'Toast Title',
            position: 'bottomLeft',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultAutohide').click(function() {
          $(document).Toasts('create', {
            title: 'Toast Title',
            autohide: true,
            delay: 750,
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultNotFixed').click(function() {
          $(document).Toasts('create', {
            title: 'Toast Title',
            fixed: false,
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultFull').click(function() {
          $(document).Toasts('create', {
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            icon: 'fas fa-envelope fa-lg',
          })
        });
        $('.toastsDefaultFullImage').click(function() {
          $(document).Toasts('create', {
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            image: '../../dist/img/user3-128x128.jpg',
            imageAlt: 'User Picture',
          })
        });
        $('.toastsDefaultSuccess').click(function() {
          $(document).Toasts('create', {
            class: 'bg-success',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultInfo').click(function() {
          $(document).Toasts('create', {
            class: 'bg-info',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultWarning').click(function() {
          $(document).Toasts('create', {
            class: 'bg-warning',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultDanger').click(function() {
          $(document).Toasts('create', {
            class: 'bg-danger',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
        $('.toastsDefaultMaroon').click(function() {
          $(document).Toasts('create', {
            class: 'bg-maroon',
            title: 'Toast Title',
            subtitle: 'Subtitle',
            body: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr.'
          })
        });
      });
    </script>


    <!-- Firebase Configuration and Initialization -->
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyATyExca-cyCg3VLZOxT_qmPvmfE4CrLc8",
        authDomain: "flutterassurance-pfe.firebaseapp.com",
        projectId: "flutterassurance-pfe",
        storageBucket: "flutterassurance-pfe.appspot.com",
        messagingSenderId: "585908465035",
        appId: "1:585908465035:web:2426e04381fa78deae538e",
        measurementId: "G-H1LMTC28ZH",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Fetch user data from Firestore


      document.addEventListener("DOMContentLoaded", function() {
        // Firestore reference
        const db = firebase.firestore();

        // Function to fetch and display the number of responses
        function updateResponseCount() {
            db.collection("responses").get()
                .then((querySnapshot) => {
                    const responseCount = querySnapshot.size;
                    document.getElementById("response-count").innerText = responseCount;
                })
                .catch((error) => {
                    console.error("Error getting response count: ", error);
                });
        }

        // Function to fetch and display the number of users
        function updateUserCount() {
            db.collection("users").get()
                .then((querySnapshot) => {
                    const userCount = querySnapshot.size;
                    document.getElementById("user-count").innerText = userCount;
                })
                .catch((error) => {
                    console.error("Error getting user count: ", error);
                });
        }

        // Update counts on page load
        updateResponseCount();
        updateUserCount();
    });

















      db.collection("users")
        .get()
        .then((querySnapshot) => {
          const userTableBody = document.getElementById("user-table-body");
          let userIndex = 1;

          querySnapshot.forEach((doc) => {
            const userData = doc.data();
          // Log the user data to the console

            // Fetch the number of responses for each user
            db.collection("responses")
              .where("userId", "==", doc.id)
              .get()
              .then((responseSnapshot) => {
                const responseCount = responseSnapshot.size;
                const createdAt = userData.createdAt
                  ? userData.createdAt.toDate()
                  : null;
                const userRow = document.createElement("tr");

                userRow.innerHTML = `
                <td>${userIndex++}</td>
                <td>
                  <a>${
                    userData.fullname ? userData.fullname : userData.name
                  }</a>
                  <br/>
                  ${
                    createdAt
                      ? `<small>Created ${createdAt.toDateString()}</small>`
                      : ""
                  }
                </td>
                <td class="project-state text-center">
                  <span class="badge badge-info">${responseCount}</span>
                </td>
                <td class="project-actions text-right">
                  <a class="btn btn-primary btn-sm" href="#">
                    <i class="fas fa-folder"></i> View
                  </a>
                  <button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal-default">
                     <i class="fas fa-pen"></i>
                  Edit
                </button>
                  <a class="btn btn-danger btn-sm delete-button" href="#" data-user-id="${
                    doc.id
                  }">
                    <i class="fas fa-trash"></i> Delete
                  </a>
                </td>
              `;

                userTableBody.appendChild(userRow);
              })
              .catch((error) => {
                console.error("Error fetching responses: ", error);
              });
          });

          // Attach event listeners to delete buttons
          userTableBody.addEventListener("click", function (event) {
            if (event.target && event.target.closest(".delete-button")) {
              const userId = event.target
                .closest(".delete-button")
                .getAttribute("data-user-id");
              if (userId) {
                deleteUser(userId);
              }
            }
          });
        })
        .catch((error) => {
          console.error("Error fetching user data: ", error);
        });

      // Function to delete a user and their data
      function deleteUser(userId) {
        // Delete user from Firestore
        db.collection("users")
          .doc(userId)
          .delete()
          .then(() => {
            console.log("User document deleted successfully from Firestore");

            // Delete user responses
            return db
              .collection("responses")
              .where("userId", "==", userId)
              .get();
          })
          .then((querySnapshot) => {
            const batch = db.batch();
            querySnapshot.forEach((doc) => {
              batch.delete(doc.ref);
            });
            return batch.commit();
          })
          .then(() => {
            console.log("User responses deleted successfully");

            // Remove user row from the table
            document
              .querySelector(`[data-user-id="${userId}"]`)
              .closest("tr")
              .remove();

            // Delete user from Firebase Auth
            auth.currentUser
              .delete()
              .then(() => {
                console.log("User deleted from Firebase Auth");
              })
              .catch((error) => {
                console.error(
                  "Error deleting user from Firebase Auth: ",
                  error
                );
              });
          })
          .catch((error) => {
            console.error("Error deleting user or responses: ", error);
          });
      }
      db.collection("responses");
      db.collection("responses")
        .get()
        .then((querySnapshot) => {
          const responseTableBody = document.getElementById(
            "response-table-body"
          );
        // Log the table body element to verify it exists

          let responseIndex = 1;
          querySnapshot.forEach((doc) => {
            const responseData = doc.data();


            if (responseData.timestamp && responseData.userId) {
              const createdAt = responseData.timestamp.toDate();
              const userId = responseData.userId; // Assuming the response has a userId field

              // Fetch the user data from the 'users' collection
              db.collection("users")
                .doc(userId)
                .get()
                .then((userDoc) => {
                  if (userDoc.exists) {
                    const userData = userDoc.data();


                    const responseRow = document.createElement("tr");
                    responseRow.dataset.docId = doc.id; // Store the document ID

                    responseRow.innerHTML = `
                <td>${responseIndex++}</td>
                <td>
                  <a>${responseData.type}</a>
                  <br/>
                  <small>Created ${createdAt.toDateString()}</small>
                </td>
                <td class="project-state text-center">
                  <span class="badge badge-warning">${createdAt.toDateString()}</span>
                </td>
                <td>${
                  userData.fullname || userData.name
                }</td> <!-- Display the user's name -->
                <td class="project-actions text-right">
                  <a class="btn btn-primary btn-sm" href="#">
                    <i class="fas fa-folder"></i> View
                  </a>
                  <a class="btn btn-info btn-sm" href="#">
                    <i class="fas fa-pencil-alt"></i> Edit
                  </a>
                  <a class="btn btn-danger btn-sm delete-btn" href="#">
                    <i class="fas fa-trash"></i> Delete
                  </a>
                </td>
              `;

                    // Log the row to be appended
                    responseTableBody.appendChild(responseRow);
                  } else {
                    console.warn("No user found with ID:", userId);
                  }
                })
                .catch((error) => {
                  console.error("Error fetching user data: ", error);
                });
            } else {
              console.warn(
                "Missing timestamp or userId field in response data",
                responseData
              );
            }
          });

          // After the table is populated, add click event listeners to delete buttons
          addDeleteEventListeners();
        })
        .catch((error) => {
          console.error("Error fetching responses: ", error);
        });

      function addDeleteEventListeners() {
        const deleteButtons = document.querySelectorAll(".delete-btn");
        deleteButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default action of the anchor tag

            const responseRow = button.closest("tr");
            const docId = responseRow.dataset.docId;

            // Confirm deletion
            if (confirm("Are you sure you want to delete this response?")) {
              // Remove the row from the table
              responseRow.remove();

              // Delete the document from Firestore
              db.collection("responses")
                .doc(docId)
                .delete()
                .then(() => {
                  console.log(
                    `Document with ID ${docId} successfully deleted.`
                  );
                })
                .catch((error) => {
                  console.error("Error removing document: ", error);
                });
            }
          });
        });
      }

      document.getElementById("submitBtn").addEventListener("click", () => {
        const fullname = document.getElementById("fullname").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const birthdate = document.getElementById("birthdate").value;
        const country = document.getElementById("country").value;
        const nationalId = document.getElementById("nationalId").value;
        const phone = document.getElementById("phone").value;
        const profileImageUrl =
          document.getElementById("profileImageUrl").value;
        const username = document.getElementById("username").value;
        const role = document.getElementById("role").value;

        console.log("Form data:", {
          fullname,
          email,
          password,
          birthdate,
          country,
          nationalId,
          phone,
          profileImageUrl,
          username,
          role,
        });

        // Create user with Firebase Authentication
        auth
          .createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            console.log("User created with UID:", userCredential.user.uid);
            const userId = userCredential.user.uid;

            // Store user data in Firestore
            db.collection("users")
              .doc(userId)
              .set({
                fullname: fullname,
                email: email,
                birthdate: birthdate,
                country: country,
                nationalId: nationalId,
                phone: phone,
                profileImageUrl: profileImageUrl,
                username: username,
                role: role,
                date_joined: new Date().toISOString(), // Add a timestamp for user creation
              })
              .then(() => {
                console.log("User data successfully stored in Firestore!");
                // Optionally, you can reset the form or provide feedback to the user
                document.getElementById("userForm");
              })
              .catch((error) => {
                console.error("Error storing user data: ", error);
              });
          })
          .catch((error) => {
            console.error("Error creating user: ", error);
          });
      });

      window.onload = fetchUsersAndContractCounts;


////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////



async function populateUserSelect() {
      var userSelect = document.getElementById("userSelect");
      try {
        var usersSnapshot = await db.collection("users").get();
        usersSnapshot.forEach(function (doc) {
          var user = doc.data();
          var option = document.createElement("option");
          option.value = doc.id;
          option.textContent = user.name || user.fullname || "Unknown Name";
          userSelect.appendChild(option);
          console.log("User:", user); // Debugging log to verify user data
        });
      } catch (error) {
        console.error("Error fetching users:", error); // Error handling
      }
    }

    document.getElementById("submitBtnContract").addEventListener("click", function () {
      var userId = document.getElementById("userSelect").value;
      var type = document.getElementById("type").value;
      var expiryDate = document.getElementById("expiryDate").value;
      var addedDate = document.getElementById("addedDate").value;
      var price = document.getElementById("price").value;
      var status = document.getElementById("status").value;

      console.log("Form data:", {
        userId: userId,
        type: type,
        expiryDate: expiryDate,
        addedDate: addedDate,
        price: price,
        status: status,
      });

      db.collection("responses")
        .doc()
        .set({
          userId: userId,
          type: type,
          expiryDate: expiryDate,
          addedDate: addedDate,
          price: price,
          status: status,
          createdAt: new Date().toISOString(),
        })
        .then(function () {
          console.log("User data successfully stored in Firestore!");
          document.getElementById("responseForm").reset();
        })
        .catch(function (error) {
          console.error("Error storing user data:", error);
        });
    });
    document.addEventListener("DOMContentLoaded", function() {
      // Firestore reference
      const db = firebase.firestore();

      // Function to fetch and display the number of responses
      function updateResponseCount() {
          db.collection("responses").get()
              .then((querySnapshot) => {
                  const responseCount = querySnapshot.size;
                  document.getElementById("response-count").innerText = responseCount;
              })
              .catch((error) => {
                  console.error("Error getting response count: ", error);
              });
      }

      // Function to fetch and display the number of users
      function updateUserCount() {
          db.collection("users").get()
              .then((querySnapshot) => {
                  const userCount = querySnapshot.size;
                  document.getElementById("user-count").innerText = userCount;
              })
              .catch((error) => {
                  console.error("Error getting user count: ", error);
              });
      }

      // Update counts on page load
      updateResponseCount();
      updateUserCount();
  });

    // Call the function to populate the user select dropdown
    populateUserSelect();
    </script>

  </body>
</html>
