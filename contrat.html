<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MaghrebiaAdmin | Contrats</title>
    <!-- Include all the stylesheets as before -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"/>
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" />
    <link rel="stylesheet" href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css" />
    <link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css" />
    <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css" />
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
    <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css" />
    <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="plugins/summernote/summernote-bs4.min.css" />
</head>
<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <!-- Preloader -->
        <div class="preloader flex-column justify-content-center align-items-center">
            <img class="animation__shake" src="dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60" />
        </div>

        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <!-- Left navbar links -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
            </ul>
            <!-- Right navbar links -->
            <ul class="navbar-nav ml-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link" data-toggle="dropdown" href="#">
                        <i class="far fa-bell"></i>
                        <span class="badge badge-warning navbar-badge">15</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                        <span class="dropdown-item dropdown-header">15 Notifications</span>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-envelope mr-2"></i> 4 new messages
                            <span class="float-right text-muted text-sm">3 mins</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-users mr-2"></i> 8 friend requests
                            <span class="float-right text-muted text-sm">12 hours</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item">
                            <i class="fas fa-file mr-2"></i> 3 new reports
                            <span class="float-right text-muted text-sm">2 days</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </a>
                </li>
            </ul>
        </nav>
        <!-- /.navbar -->

        <!-- Main Sidebar Container -->
        <aside class="main-sidebar sidebar-light-primary elevation-4">
            <!-- Brand Logo -->
            <a href="index3.html" class="brand-link">
                <img src="dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: 0.8" />
                <span class="brand-text font-weight-bold">Admin Maghrebia</span>
            </a>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Sidebar user panel (optional) -->
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="dist/img/portrait-cute-girl-with-brown-hair-3d-rendering_1142-43502.jpg" class="img-circle elevation-2" alt="User Image" />
                    </div>
                    <div class="info">
                        <a href="#" class="d-block">Zeineb Touil</a>
                    </div>
                </div>

                <!-- SidebarSearch Form -->
                <div class="form-inline">
                    <div class="input-group" data-widget="sidebar-search">
                        <input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search" />
                        <div class="input-group-append">
                            <button class="btn btn-sidebar">
                                <i class="fas fa-search fa-fw"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Menu -->
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                        <li class="nav-item menu-open">
                            <a href="./dashboard.html" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li class="nav-item menu-open">
                            <a href="./indexContrat.html" class="nav-link active">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>Contrats</p>
                            </a>
                        </li>

                    </ul>
                </nav>
                <!-- /.sidebar-menu -->
            </div>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">Responses</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active">Dashboard v1</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <!-- Responses LIST -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Responses</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-striped projects">
                                <thead>
                                    <tr>
                                        <th style="width: 1%">#</th>
                                        <th style="width: 20%">Type de Contrat</th>
                                        <th style="width: 8%" class="text-center">Date de creation de Contrat</th>
                                        <th style="width: 20%">Benificiare de contrat</th>
                                        <th style="width: 20%"></th>
                                    </tr>
                                </thead>
                                <tbody id="response-table-body">
                                    <!-- User data will be populated here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <section class="content">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card card-secondary">
                                    <div class="card-header">
                                        <h3 class="card-title">Ajouter un Contrat</h3>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <form id="responseForm">
                                            <div class="form-group">
                                                <label for="type">Type de contrat</label>
                                                <select id="type" class="form-control custom-select" required>
                                                    <option selected disabled>Type</option>
                                                    <option value="maladie">Maladie</option>
                                                    <option value="vie">Vie</option>
                                                    <option value="habitation">Habitation</option>
                                                    <option value="Auto">Auto</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="userSelect">Nom et Prénom</label>
                                                <select id="userSelect" class="form-control" required>
                                                    <option value="" disabled selected>Select User</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="addedDate">Date de Debut</label>
                                                <input type="date" id="addedDate" class="form-control" required />
                                            </div>
                                            <div class="form-group">
                                                <label for="expiryDate">Date d'expiration</label>
                                                <input type="date" id="expiryDate" class="form-control" required />
                                            </div>
                                            <div class="form-group">
                                                <label for="price">Prix De contrat</label>
                                                <input type="text" id="price" class="form-control" required />
                                            </div>
                                            <div class="form-group">
                                                <label for="status">Status de contrat</label>
                                                <select id="status" class="form-control custom-select" required>
                                                    <option selected disabled>Status</option>
                                                    <option value="paye">Paye</option>
                                                    <option value="enattente">En attente</option>
                                                    <option value="epired">Expire</option>
                                                </select>
                                            </div>
                                            <div class="row">
                                                <div class="col-12">
                                                    <button type="button" id="submitBtnContract" class="btn btn-success float-right">Create New Contract</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <!--/.card -->
                </div>
            </div>
        </div>

        <!-- /.content-wrapper -->

        <footer class="main-footer">
            <div class="float-right d-none d-sm-block"><b>Version</b> 3.2.0</div>
            <strong>Copyright &copy; 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
        </footer>

        <aside class="control-sidebar control-sidebar-dark">
            <!-- Control sidebar content goes here -->
        </aside>
    </div>
    <!-- ./wrapper -->

    <!-- jQuery and other scripts as before -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="dist/js/adminlte.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <!-- <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-functions.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-admin.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
          apiKey: "AIzaSyATyExca-cyCg3VLZOxT_qmPvmfE4CrLc8",
          authDomain: "flutterassurance-pfe.firebaseapp.com",
          projectId: "flutterassurance-pfe",
          storageBucket: "flutterassurance-pfe.appspot.com",
          messagingSenderId: "585908465035",
          appId: "1:585908465035:web:2426e04381fa78deae538e",
          measurementId: "G-H1LMTC28ZH",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Fetch and display responses from Firestore
 // Fetch and display responses from Firestore
// Fetch and display responses from Firestore
db.collection("responses")
    .get()
    .then(async (querySnapshot) => {
        const responseTableBody = document.getElementById("response-table-body");
        let responseIndex = 1;
        const userPromises = [];

        querySnapshot.forEach((doc) => {
            const responseData = doc.data();
            if (responseData.userId) {
                const createdAt = responseData.createdAt && responseData.createdAt.toDate ? responseData.createdAt.toDate().toLocaleDateString() : "N/A";
                const userId = responseData.userId;

                const userPromise = db.collection("users").doc(userId).get()
                    .then((userDoc) => {
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const responseRow = document.createElement("tr");
                            responseRow.dataset.docId = doc.id; // Store the document ID

                            responseRow.innerHTML = `
                                <td>${responseIndex++}</td>
                                <td>
                                    <a>${responseData.type}</a>
                                    <br/>
                                    <small>Created ${createdAt}</small>
                                </td>
                                <td class="project-state text-center">
                                    <span class="badge badge-warning">${createdAt}</span>
                                </td>
                                <td>${userData.fullname || userData.name}</td>
                                <td class="project-actions text-right">
                                    <a class="btn btn-primary btn-sm" href="#" onclick="event.preventDefault();">
                                        <i class="fas fa-folder"></i> View
                                    </a>
                                    <a class="btn btn-info btn-sm" href="#" onclick="event.preventDefault();">
                                        <i class="fas fa-pencil-alt"></i> Edit
                                    </a>
                                    <a class="btn btn-danger btn-sm delete-btn" id="${doc.id}" href="#" onclick="event.preventDefault();">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </td>
                            `;

                            responseTableBody.appendChild(responseRow);
                        } else {
                            console.warn("No user found with ID:", userId);
                        }
                    })
                    .catch((error) => {
                        console.error("Error fetching user data: ", error);
                    });

                userPromises.push(userPromise);
            } else {
                console.warn("Missing timestamp or userId field in response data", responseData);
            }
        });

        // Wait for all user data to be fetched and rows to be populated
        await Promise.all(userPromises);
        addDeleteEventListeners(); // Call the function to add event listeners after the table is populated
    })
    .catch((error) => {
        console.error("Error fetching responses: ", error);
    });

// Add event listeners to delete buttons
function addDeleteEventListeners() {
    const deleteButtons = document.querySelectorAll(".delete-btn");
    console.log("deleteButtons====", deleteButtons);
    deleteButtons.forEach((button) => {
        button.addEventListener("click", (event) => {
            event.preventDefault(); // Prevent default action of the anchor tag

            const responseRow = button.closest("tr");
            const docId = responseRow.dataset.docId;
            console.log("Delete button clicked. Doc ID:", docId);

            // Confirm deletion
            if (confirm("Are you sure you want to delete this response?")) {
                // Remove the row from the table
                responseRow.remove();

                // Delete the document from Firestore
                db.collection("responses")
                    .doc(docId)
                    .delete()
                    .then(() => {
                        console.log(`Document with ID ${docId} successfully deleted.`);
                    })
                    .catch((error) => {
                        console.error("Error removing document: ", error);
                    });
            }
        });
    });
}



      // Populate user select dropdown
      async function populateUserSelect() {
          const userSelect = document.getElementById("userSelect");
          try {
              const usersSnapshot = await db.collection("users").get();
              usersSnapshot.forEach((doc) => {
                  const user = doc.data();
                  const option = document.createElement("option");
                  option.value = doc.id;
                  option.textContent = user.name || user.fullname || "Unknown Name";
                  userSelect.appendChild(option);
                  console.log("User added to select:", user); // Debugging log to verify user data
              });
          } catch (error) {
              console.error("Error fetching users:", error); // Error handling
          }
      }

      // Event listener for form submission
      document.getElementById("submitBtnContract").addEventListener("click", function () {
          const userId = document.getElementById("userSelect").value;
          const type = document.getElementById("type").value;
          const expiryDate = document.getElementById("expiryDate").value;
          const addedDate = document.getElementById("addedDate").value;
          const price = document.getElementById("price").value;
          const status = document.getElementById("status").value;

          console.log("Form data:", {
              userId: userId,
              type: type,
              expiryDate: expiryDate,
              addedDate: addedDate,
              price: price,
              status: status,
          });

          db.collection("responses")
              .add({
                  userId: userId,
                  type: type,
                  expiryDate: expiryDate,
                  addedDate: addedDate,
                  price: price,
                  status: status,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              })
              .then(function () {
                  console.log("Contract successfully stored in Firestore!");
                  document.getElementById("responseForm").reset();
              })
              .catch(function (error) {
                  console.error("Error storing contract data:", error);
              });
      });

      // Call the function to populate the user select dropdown after the window loads
      window.onload = function () {
          populateUserSelect();

      };


  </script>
</body>
</html>
